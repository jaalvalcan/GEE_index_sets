import ee
import geemap
import xarray as xr
!pip install geemap
!pip install
!pip install xee
!pip install rioxarray
!pip install
import xee
import rioxarray
import matplotlib.pyplot as plt
import pandas as pd

ee.Authenticate()
ee.Initialize(project='ee-JJJJJJJ')



# üìç STEP 1: DEFINE YOUR LOCATION HERE (EDIT THIS BLOCK ONLY!)
LOCATION_NAME = "London"  # ‚Üê Change this to "Shetland Islands", "Paris", etc.
AOI_COORDS = [-0.5, 51.3, 0.3, 51.7]  # [west, south, east, north] for London


# Create AOI geometry
aoi = ee.Geometry.Rectangle(AOI_COORDS, 'EPSG:4326')

# Rest of your code (unchanged logic, just uses `aoi` and `LOCATION_NAME`)
def mask_s2_clouds(image):
    cloud_prob = image.select('probability')
    is_cloud = cloud_prob.gt(5)
    return image.updateMask(is_cloud.Not())

s2_sr = ee.ImageCollection('COPERNICUS/S2_SR_HARMONIZED') \
    .filterBounds(aoi) \
    .filterDate('2020-01-01', '2020-12-31') \
    .filter(ee.Filter.lt('CLOUDY_PIXEL_PERCENTAGE', 50))

s2_cloudless = ee.ImageCollection('COPERNICUS/S2_CLOUD_PROBABILITY') \
    .filterBounds(aoi) \
    .filterDate('2020-01-01', '2020-12-31')

joined = ee.ImageCollection(ee.Join.saveFirst('cloud_prob').apply(
    primary=s2_sr,
    secondary=s2_cloudless,
    condition=ee.Filter.equals(leftField='system:index', rightField='system:index')
))

def add_cloud_prob(image):
    cloud_prob = ee.Image(image.get('cloud_prob')).select('probability')
    return image.addBands(cloud_prob)

with_cloud_prob = joined.map(add_cloud_prob)

def compute_monthly_cloudiness(start_date):
    end_date = ee.Date(start_date).advance(1, 'month')
    monthly = with_cloud_prob.filterDate(start_date, end_date)
    
    if monthly.size().getInfo() == 0:
        return {'month': ee.Date(start_date).get('month').getInfo(), 'cloud_pct': 100.0}
    
    def cloud_binary(img):
        return img.select('probability').gt(5).rename('cloudy')
    
    cloud_binary_collection = monthly.map(cloud_binary)
    mean_cloud = cloud_binary_collection.mean().clip(aoi)
    
    stats = mean_cloud.reduceRegion(
        reducer=ee.Reducer.mean(),
        geometry=aoi,
        scale=100,
        maxPixels=1e9
    ).get('cloudy').getInfo()
    
    cloud_pct = (stats * 100) if stats is not None else 100.0
    month_num = ee.Date(start_date).get('month').getInfo()
    return {'month': month_num, 'cloud_pct': cloud_pct}

# Process all months
months_2020 = [f'2020-{str(m).zfill(2)}-01' for m in range(1, 13)]
results = []

for m in months_2020:
    print(f"Processing {m} for {LOCATION_NAME}...")
    res = compute_monthly_cloudiness(m)
    results.append(res)

# Display results
df = pd.DataFrame(results)
df['month_name'] = pd.to_datetime(df['month'], format='%m').dt.month_name()
df = df.sort_values('month')

print(f"\n‚òÅÔ∏è Monthly Cloudiness (%) over {LOCATION_NAME} in 2020:")
print(df[['month_name', 'cloud_pct']].to_string(index=False))

clearest = df.loc[df['cloud_pct'].idxmin()]
print(f"\n‚úÖ Clearest month in {LOCATION_NAME}: {clearest['month_name']} ({clearest['cloud_pct']:.2f}% cloudy)")
